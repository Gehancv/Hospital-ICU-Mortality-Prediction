---
title: "DM2-EDA"
output: html_document
date: "`r Sys.Date()`"
---

```{r}
rm(list = ls())
library(readr)
#read dataset
data <- read_csv("dataset/training_v2.csv/training_v2.csv")
dim(data)
```

#Data Preparation/Cleaning
```{r}
#remove the id columns from dataset
data$encounter_id <- NULL
data$hospital_id <- NULL
data$patient_id <- NULL
data$icu_id <- NULL
#drop variables which has null values more than 15%
data <- data[, which(colMeans(is.na(data)) < 0.15)]
dim(data)
```

```{r}
#summary of dataset
summary(data)
#remove because the variable only has a constant value of 0
data$gcs_unable_apache <- NULL
data$readmission_status <- NULL
data$apache_4a_hospital_death_prob <- NULL
data$apache_4a_icu_death_prob <- NULL
```

```{r}
library(ggplot2)
ggplot(data, aes(hospital_death)) + 
  geom_histogram()
```

```{r}
#Remove rows with NA's
data_new <- na.omit(data)
print(dim(data_new))
summary(data_new)
```

```{r}
#Combining categories with less than 5% observations into one
data_new$ethnicity[data_new$ethnicity == "Native American" | data_new$ethnicity== "Asian" | data_new$ethnicity == "Hispanic"] <- "Other/Unknown"
#data_new$icu_admit_source[data_new$icu_admit_source == "Other Hospital" | data_new$icu_admit_source == "Other ICU"] <- "other"
#Replacing duplicate factor label with one single label
data_new$apache_2_bodysystem[data_new$apache_2_bodysystem == 'Undefined diagnoses'] <- 'Undefined Diagnoses'

#Factoring
data_new$ethnicity <- as.factor(data_new$ethnicity)
data_new$icu_admit_source <- as.factor(data_new$icu_admit_source)
data_new$gender <- as.factor(data_new$gender)
data_new$icu_stay_type <- as.factor(data_new$icu_stay_type)
data_new$apache_2_bodysystem <- as.factor(data_new$apache_2_bodysystem)
data_new$icu_type <- as.factor(data_new$icu_type)
data_new$apache_3j_bodysystem <- as.factor(data_new$apache_3j_bodysystem)
data_new$leukemia <- as.factor(data_new$leukemia)
data_new$lyphoma <- as.factor(data_new$lymphoma)
data_new$cirrhosis <- as.factor(data_new$cirrhosis)
data_new$diabetes_mellitus <- as.factor(data_new$diabetes_mellitus)
data_new$hepatic_failure <- as.factor(data_new$hepatic_failure)
data_new$immunosuppression <- as.factor(data_new$immunosuppression)
data_new$aids <- as.factor(data_new$aids)
data_new$arf_apache <- as.factor(data_new$arf_apache)
#data_new$hospital_death = as.factor(data_new$hospital_death)
summary(data_new)
```

#Perform oversampling to balance the dataset 
```{r}
#install.packages("ROSE")
library(ROSE)

#data_balanced <- ROSE(hospital_death ~ ., data = data_new, seed = 1000)$data
data_balanced <- ovun.sample(hospital_death ~ .,
                             data = data_new,
                             N = nrow(data_new),
                             seed = 1000,
                             method = "both")$data
                             
summary(data_balanced)
```

#PCA
```{r}
library(dplyr)
data_pca <- data_balanced
data_pca <- select_if(data_pca, is.numeric)
data_pca$hospital_death <- NULL
PCA.scaled <- prcomp(data_pca, center = TRUE, scale = TRUE)

#proportion of variance explained by each principal component
variance_prop <- PCA.scaled$sdev^2 / sum(PCA.scaled$sdev^2)
cum_variance_prop <- cumsum(variance_prop)
num_pcs <- sum(cum_variance_prop <= 0.5)
PCA.selected <- PCA.scaled$x[,1:num_pcs]
PCA.selected
```

```{r}
hospital_death <- data_balanced$hospital_death
data_balanced <- select_if(data_balanced, Negate(is.numeric))
data_balanced <- cbind(data_balanced, hospital_death)
data_balanced <- cbind(data_balanced, PCA.selected)
summary(data_balanced)
```

```{r}
#Manul binarization
library(caret)
vars.categorical <- c("ethnicity","icu_admit_source","gender","icu_type","icu_stay_type","apache_2_bodysystem","apache_3j_bodysystem")
binarizer <- dummyVars(paste("~", paste(vars.categorical, collapse = "+")),
                        data = data_new, fullRank = TRUE)
binarized_vars <- data.frame(predict(binarizer, newdata = data_balanced))
data_balanced <- cbind(data_balanced, binarized_vars)
data_balanced$ethnicity <- NULL
data_balanced$icu_admit_source <- NULL
data_balanced$gender <- NULL
data_balanced$icu_stay_type <- NULL
data_balanced$icu_type <- NULL
data_balanced$apache_2_bodysystem <- NULL
data_balanced$apache_3j_bodysystem <- NULL
summary(data_balanced)
```

```{r}
library(caret)
set.seed(1000)
partition <- createDataPartition(data_balanced$hospital_death, p = 0.75, list = FALSE)
data.train <- data_balanced[partition, ]
data.test <- data_balanced[-partition, ]
mean(data.train$hospital_death)
mean(data.test$hospital_death)
```

#Regularization
```{r}
#library(glmnet)

# X.train <- model.matrix(hospital_death ~ ., data = data.train)
# 
# set.seed(1111)
# m <- cv.glmnet(x = X.train,
#               y = data.train$hospital_death,
#               family = "binomial",
#               nfold = 10,
#               #lambda = NULL,
#               lambda = 1:20,
#               alpha = 0.5)
# plot(m)
```

## Fitting Different models for classifying hospital mortality

# GLM
# GLM Train
```{r}
model.logit.full <- glm(hospital_death ~ ., 
                         data = data.train,
                         family = binomial(link = "logit"))
AIC(model.logit.full)
summary(model.logit.full)
```
#GLM Predict
```{r}
cutoff <- 0.5

# Generate predicted probabilities on the training set
predict.logit.train <- predict(model.logit.full, type = "response")
# Turn predicted probabilities into predicted classes
class.train <- 1*(predict.logit.train > cutoff) # OR ifelse(pred.train > cutoff, 1, 0)
confusionMatrix(factor(class.train), factor(data.train$hospital_death), positive = "1")

predict.logit.test <- predict(model.logit.full, newdata = data.test, type = "response")
class.logit <- 1*(predict.logit.test > cutoff)
confusionMatrix(factor(class.logit), factor(data.test$hospital_death))
```
With 0.5 cutoff, training accuracy is 0.7602 and testing accuracy is 0.7681
The sensitivity is higher than specificity meaning that the model is better 
at classifying patients who died.This is the primary objective of this model

# ROC AUC
```{r}
library(pROC)
roc.logit.train <- roc(data.train$hospital_death, predict.logit.train)
par(pty = "s")  # This improves the appearance of the roc plot
plot(roc.logit.train)
auc(roc.logit.train)

roc.logit.test <- roc(data.test$hospital_death, predict.logit.test)
plot(roc.logit.test)
auc(roc.logit.test)
```

# Stepwise AIC
```{r}
library(MASS)
model.logit.null <- glm(hospital_death ~ 1,
                  data = data.train,
                  family = binomial(link = "logit"))
# model.logit.reduced <- stepAIC(model.logit.null,
#                          direction = "backward",
#                          k = log(nrow(data.train)),
#                          scope = list(upper = model.logit.full, lower = model.logit.null))
model.logit.reduced <- stepAIC(model.logit.full)
summary(model.logit.reduced)
```

# GLM Reduced 
```{r}
predict.logit.reduced <- predict(model.logit.reduced, newdata = data.test, type = "response")
roc.logit.reduced <- roc(data.test$hospital_death, predict.logit.reduced)
auc(roc.logit.reduced)
```

# Decision Tree
```{r}
library(rpart)
library(rpart,plot)

set.seed(1000)

# method = "class" ensures that target is treated as a categorical variable
model.tree <- rpart(hospital_death ~ .,
               data = data.train,
               method = "class",
               control = rpart.control(minbucket = 5,
                                       cp = 0.0005,
                                       maxdepth = 7),
               parms = list(split = "gini"))

# Print output for the tree
model.tree

# Plot the tree
rpart.plot(model.tree, tweak = 2)
```

```{r}
model.tree$cptable
```

```{r}
model.tree.pruned <- prune(model.tree, cp = model.tree$cptable[23, "CP"])
model.tree.pruned

# Plot the tree
rpart.plot(mode.tree.pruned)
```

```{r}
rpart.plot(mode.tree.pruned, type = 0)
rpart.plot(mode.tree.pruned, digits = 4, extra = 4)
```

```{r}
predict.tree.class <- predict(model.tree, newdata = data.test, type = "class")
predict.tree.reduced.class <- predict(model.tree.pruned, newdata = data.test, type = "class")

confusionMatrix(predict.tree.class, as.factor(data.test$hospital_death), positive = "1")
confusionMatrix(predict.tree.reduced.class, as.factor(data.test$hospital_death), positive = "1")
```

# Random forest
```{r}
# Set the controls
ctrl <- trainControl(method = "repeatedcv",
                     number = 5,
                     repeats = 3)

# Set up the tuning grid
rf.grid <- expand.grid(mtry = 1:15)
rf.grid
```

```{r}
# Set up the x and y variables
target <- factor(data.train$wage_flag)
predictors <- data.train[, -9]

# Train the first random forest
set.seed(1000)
model.rf <- train(hospital_death ~ .,
                  data = data.train,
                  method = "rf",
                  ntree = 5,
                  importance = TRUE,
                  trControl = ctrl,
                  tuneGrid = rf.grid)
```

```{r}
# View the output
rf1
ggplot(rf1)  # OR simply plot(rf1)
```